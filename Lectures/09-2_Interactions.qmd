---
title: "Interactions"
author:
  - Elizabeth King
  - Kevin Middleton
format:
  revealjs:
    theme: [default, custom.scss]
    standalone: true
    self-contained: true
    logo: QMLS_Logo.png
    slide-number: true
    show-slide-number: all
code-annotations: hover
bibliography: QMLS_Bibliography.bib
csl: evolution.csl
---


```{r}
#| label: setup
#| echo: false
#| message: false
#| warning: false

library(tidyverse)
library(cowplot)
theme_set(theme_cowplot())

library(readxl)
library(car)
library(paletteer)
library(ggsci)
```


<!--
Datasets
  biomass.csv
-->


## Factorial designs and interactions

![](https://i.imgur.com/tcMSr7k.png){fig-align="center"}

- Allow you to explore *interactions* (multiplicative effects)

If you have multiple categorical variables, you should *always* do factorial designs (unless you know why you aren't).


## Interaction model

Add a new predictor ($\beta_3$) that is the product of $X_1$ and $X_2$:

$$Y = \beta_0 + \beta_1 X_1 + \beta_2 X_2 + \beta_3 (X_1 X_2) + \epsilon$$

The value of $X_1$ varies with change in the value of $X_2$ (and vice versa - these are not really separable).


## Factorial data

Biomass gain in plants fertilized with either added nitrogen or phosphorous.

![](https://i.imgur.com/5VY9vwE.png){fig-align="center"}


## Factorial data

Biomass gain in plants fertilized with either added nitrogen or phosphorous.

```{r}
BM <- read_csv("../data/biomass.csv", show_col_types = FALSE)
BM
```


## Factorial data

Balanced data: Equal *n* in each group

```{r}
BM |> count(Nitrogen, Phosphorous)
```

Balanced data is the best to work with.


## Visualizing factorial data


```{r}
ggplot(BM, aes(x = Nitrogen, y = Biomass, color = Phosphorous)) +
  geom_point(position = position_jitter(width = 0.1), size = 3) +
  scale_color_paletteer_d("ggsci::default_jco")
```


## Interaction plot

```{r}
#| label: int_plot1
#| echo: true
#| output-location: slide

ggplot(BM, aes(x = Nitrogen,
               y = Biomass,
               color = Phosphorous,
               group = Phosphorous)) +
  geom_point(position = position_jitter(width = 0.1), size = 3, alpha = 0.5) +
  stat_summary(fun = mean, geom = "point", size = 6) +
  stat_summary(fun = mean, geom = "line", linewidth = 1.5) +
  scale_color_paletteer_d("ggsci::default_jco") +
  theme(legend.position = "bottom")
```


## Interaction plot

```{r}
ggplot(BM, aes(x = Phosphorous,
               y = Biomass,
               color = Nitrogen,
               group = Nitrogen)) +
  geom_point(position = position_jitter(width = 0.1), size = 3, alpha = 0.5) +
  stat_summary(fun = mean, geom = "point", size = 6) +
  stat_summary(fun = mean, geom = "line", linewidth = 1.5) +
  scale_color_paletteer_d("ggsci::default_jco") +
  theme(legend.position = "bottom")
```


## Types of Interactions

Many possible patterns of interactions between two variables:

![](https://i.imgur.com/W4dqiiZ.png){fig-align="center"}


## Group means

```{r}
#| echo: true

BM |> 
  summarize(mean = mean(Biomass),
            .by = c(Nitrogen, Phosphorous))
```


## Two-way factorial ANOVA

```{r}
fm <- lm(Biomass ~ Nitrogen * Phosphorous, data = BM)
```

`Nitrogen * Phosphorous` expands to:

```{r}
#| eval: false
#| echo: true

fm <- lm(Biomass ~ Nitrogen + Phosphorous + Nitrogen:Phosphorous, 
         data = BM)
```

- Main effects of `Nitrogen` and `Phosphorous`
- Interaction term of `Nitrogen:Phosphorous` ("Nitrogen by Phosphorus")


## Two-way factorial ANOVA

```{r}
#| echo: true

summary(fm)
```


## ANOVA table

If you have a significant interaction, the main effects not interpretable **without** clarification.

```{r}
fm <- lm(Biomass ~ Phosphorous * Nitrogen, data = BM)
anova(fm)
```


## Interpretations

```{r ref.label="int_plot1", echo=FALSE, eval=TRUE}

```


## Power to detect interactions is low [@Wahlsten1990-hc]

For a 2 X 2 design

- Power to detect a main effect is 87%
- Power to detect the interaction is 16% 

ANOVA will suggest additivity of effects when in fact they are multiplicative


## Under the hood

Numeric representations of `nitrogen` and `phosphorous`:

```{r}
#| echo: true

BM$n_num <- ifelse(BM$Nitrogen == "N-", 0, 1)
BM$p_num <- ifelse(BM$Phosphorous == "P-", 0, 1)
```

Numeric representation of the interaction (multiple the other two numeric representations):

```{r}
#| echo: true

BM$interact <- BM$n_num * BM$p_num
```

1's only for the "N+" & "P+" groups. 0's for all others.


## 4 parameters define 4 groups

1. $\beta_0$ = `(Intercept)` = "N-" & "P-" group mean
1. $\beta_1$ = `n_num` = "N-" & "P+" addition
1. $\beta_2$ = `p_num` = "N+" & "P-" addition
1. $\beta_3$ = `interact` = #2 + #3 + "N+" & "P+" addition


## 4 parameters define 4 groups

```{r}
#| echo: true

BM |> slice(c(1,21,41,61,81))
```


## Under the hood

```{r}
#| echo: true

summary(lm(Biomass ~ n_num + p_num + interact, data = BM))
```


## Model matrix

R does the factor $\rightarrow$ 0/1 conversion behind the scenes:

```{r}
#| echo: true

mm <- model.matrix(Biomass ~ Nitrogen * Phosphorous, data = BM)
mm[15:25,]
```


## Unbalanced interactions are complicated

ANOVA tables, sums of squares, and hypothesis tests are all impacted

- As soon as there are interactions with an unbalanced design, variables can share variance.


## Questions get complicated:

1. What is the effect of variable 1 on y, ignoring variable 2?
2. What is the effect of variable 2 on y, ignoring variable 1?
3. What is the effect of variable 1 on y, controlling for variable 2?
4. What is the effect of variable 2 on y, controlling for variable 1?


## Partitioning variance

Different ways to partition variance has a cascading effect:

- Determines sums of squares, which
- Determines mean squares, which
- Determines *P* values

Thus you should be aware of how your ANOVA table is calculated.


## Types of sums of squares

**Type I**: "sequential", "unweighted", ordering of factors in the model matters, the R default, probably **not** what you want *if you have unbalanced sample sizes*

**Type II**: main effects allowed to overlap with their interaction terms, useful if interaction is weak

**Type III**: "weighted", each reported effect controls for all the others (including interactions)


## Types of sums of squares

Each type tests subtly different hypotheses.

- Use Type I if you have balanced data
- Type I == Type III if the groups are balanced (ideal situation - you don't have to choose)
- Type III matches the output of `summary(lm())` (so that's nice)


** CHECKME**


## Unbalanced groups

Randomly drop 20 rows:

```{r}
#| echo: true

set.seed(15)
BM_ub <- BM |> slice_sample(prop = 0.75)
BM_ub |> count(Nitrogen, Phosphorous)
```


## ANOVA Model 1

```{r}
#| echo: true

fm1 <- lm(Biomass ~ Nitrogen * Phosphorous, data = BM_ub)
anova(fm1)
```


## ANOVA Model 2

```{r}
#| echo: true

fm2 <- lm(Biomass ~ Phosphorous * Nitrogen, data = BM_ub)
anova(fm2)
```


## Type III sums of squares

```{r}
#| echo: true

library(car)
Anova(fm1, type = "III")
```


## Type III sums of squares

```{r}
#| echo: true

Anova(fm2, type = "III")
```


## Key points

1. Check your sample sizes within groups
1. Pay attention when you have interaction terms
1. Think about your sums of squares
1. Type II or Type III is likely what you want


## Higher order interaction terms

It is difficult enough to interpret an interaction in a 2 X 2 ANOVA model.

- Higher order terms multiply and become virtually impossible to comprehend

$$Biomass = \beta_0 + ... + \beta_k (N \times P \times  K)$$

- What does a significant Nitrogen X Phosphorus X Potassium interaction mean?

Split your data and carry out two analyses unless you really must.


## I really want to know more about these Type III sums of squares

Check the Canvas resources.


## These disagreements are all specific to sums of squares and variance component estimation.

Alternatives:

- Model Comparisons & Likelihood
- Bayesian Analyses


## References

::: {#refs}
:::

